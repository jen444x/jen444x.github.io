---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Icon from "../components/Icon.astro";
import { sanityClient, urlFor } from "../sanity/client";

// Fetch featured photos from Sanity (ordered by drag-and-drop rank)
const featuredPhotos = await sanityClient.fetch(`
  *[_type == "galleryItem" && featured == true] | order(orderRank asc) {
    _id,
    title,
    alt,
    image,
    category
  }[0...12]
`);

// Fetch gallery cover images from Sanity (optimized via CDN)
const categoryCovers = await sanityClient.fetch(`
  *[_type == "galleryCovers"][0] {
    "concrete": concrete[]->{ image, alt },
    "outdoor-kitchens": outdoorKitchens[]->{ image, alt },
    "covered-patios": coveredPatios[]->{ image, alt },
    "fire-features": fireFeatures[]->{ image, alt },
    "landscaping": landscaping[]->{ image, alt },
    "iron-work": ironWork[]->{ image, alt }
  }
`);

// Category metadata
const categoryMeta = [
  { slug: "concrete", name: "Concrete Work", description: "Driveways, walkways, patios, stairs & professional flatwork" },
  { slug: "outdoor-kitchens", name: "Outdoor Kitchens", description: "Luxury outdoor kitchen designs with premium countertops" },
  { slug: "covered-patios", name: "Covered Patios", description: "Elegant covered patio designs with stone columns" },
  { slug: "fire-features", name: "Fire Features", description: "Custom fire pits, outdoor fireplaces & fire feature installations" },
  { slug: "landscaping", name: "Landscaping", description: "Artificial turf, gardens, water features & landscape design" },
  { slug: "ironwork", name: "Iron Work", description: "Decorative gates, railings, archways & custom metalwork" },
];

// Map slug to Sanity field name (ironwork → iron-work)
const slugToSanityKey: Record<string, string> = {
  "ironwork": "iron-work",
};

// Build categories array with Sanity images
const categories = categoryMeta.map((cat) => {
  const sanityKey = slugToSanityKey[cat.slug] || cat.slug;
  const covers = categoryCovers?.[sanityKey] || [];

  return {
    ...cat,
    images: covers.map((item: any) => ({
      src: item?.image ? urlFor(item.image).width(600).height(450).auto('format').url() : '',
      alt: item?.alt || cat.name,
    })),
  };
});
---

<Layout
  title="Our Work — Rocky Concrete Portfolio & Project Gallery"
  description="Explore Rocky Concrete's portfolio of completed projects including concrete work, outdoor kitchens, fire pits, pool remodels, and landscaping in Bakersfield, CA."
>
  <Header />

  <main class="min-h-screen">
    <!-- Hero Section - Luxury Industrial -->
    <section
      class="relative min-h-[60vh] flex items-center justify-center bg-black-pure overflow-hidden section-padding border-t border-bronze/10"
    >
      <!-- Subtle texture overlay -->
      <div
        class="absolute inset-0 opacity-[0.03] mix-blend-overlay bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuOSIgbnVtT2N0YXZlcz0iNCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNub2lzZSkiIG9wYWNpdHk9IjAuNSIvPjwvc3ZnPg==')]"
      >
      </div>

      <div class="container relative z-20 max-w-5xl mx-auto px-6 md:px-12">
        <div class="text-center">
          <!-- Main Heading - Bebas Neue Luxury -->
          <h1
            class="font-['Bebas_Neue'] text-5xl sm:text-6xl md:text-7xl lg:text-8xl text-white mb-6 tracking-wider font-light hero-animate opacity-0"
            style="text-shadow: 0 4px 24px rgb(0 0 0 / 70%); animation-delay: 0.2s;"
          >
            OUR WORK
          </h1>

          <!-- Bronze accent line -->
          <div
            class="w-20 h-0.5 bg-bronze mx-auto mb-8 hero-animate opacity-0"
            style="animation-delay: 0.4s;"
          ></div>

          <!-- Subheading -->
          <p
            class="text-base md:text-lg text-slate-light max-w-2xl mx-auto font-light leading-relaxed hero-animate opacity-0"
            style="animation-delay: 0.6s;"
          >
            Explore our portfolio of concrete and landscaping projects across Bakersfield
          </p>
        </div>
      </div>
    </section>

    <!-- Bronze gradient line - Marks start of main content -->
    <div class="bronze-gradient-divider"></div>

    <!-- Category Grid Section -->
    <section class="category-section section-padding bg-white">
      <div class="max-w-7xl mx-auto px-6 md:px-8">
        <!-- Section Intro -->
        <div class="section-intro scroll-reveal opacity-0">
          <h2 class="font-['Bebas_Neue'] text-3xl md:text-4xl tracking-wider text-charcoal mb-4">
            Browse by Category
          </h2>
          <div class="w-16 h-0.5 bg-bronze mx-auto mb-6"></div>
          <p class="text-slate text-base md:text-lg font-light max-w-2xl mx-auto">
            Select a category to view our completed projects
          </p>
        </div>

        <!-- Category Cards Grid - BENTO LAYOUT -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
          {categories.map((category, index) => (
            <a
              href={`/gallery/${category.slug}`}
              class="category-card scroll-reveal opacity-0 group relative overflow-hidden bg-charcoal border-2 border-charcoal-light hover:border-bronze transition-all duration-500 cursor-pointer block"
              style={`animation-delay: ${(index + 1) * 0.075}s`}
            >
              {/* BENTO GRID: 1 Large Image + 2 Small Images */}
              <div class="grid grid-cols-2 gap-1 aspect-[4/3]">
                {/* Large Image - Takes full left column */}
                <div class="col-span-1 row-span-2 relative overflow-hidden bg-charcoal">
                  {category.images[0]?.src ? (
                    <img
                      src={category.images[0].src}
                      alt={category.images[0].alt}
                      class="w-full h-full object-cover transition-all duration-700 group-hover:scale-110"
                      width="600"
                      height="450"
                      loading={index < 2 ? "eager" : "lazy"}
                      fetchpriority={index === 0 ? "high" : undefined}
                    />
                  ) : (
                    <div class="w-full h-full flex items-center justify-center text-slate-light text-sm">No image</div>
                  )}
                  <div class="absolute inset-0 bg-black/30 group-hover:bg-black/45 transition-all duration-500"></div>
                </div>

                {/* Small Image Top Right */}
                <div class="relative overflow-hidden bg-charcoal">
                  {category.images[1]?.src ? (
                    <img
                      src={category.images[1].src}
                      alt={category.images[1].alt}
                      class="w-full h-full object-cover transition-all duration-700 group-hover:scale-110"
                      width="600"
                      height="450"
                      loading={index < 2 ? "eager" : "lazy"}
                      fetchpriority={index === 0 ? "high" : undefined}
                    />
                  ) : (
                    <div class="w-full h-full"></div>
                  )}
                  <div class="absolute inset-0 bg-black/30 group-hover:bg-black/45 transition-all duration-500"></div>
                </div>

                {/* Small Image Bottom Right */}
                <div class="relative overflow-hidden bg-charcoal">
                  {category.images[2]?.src ? (
                    <img
                      src={category.images[2].src}
                      alt={category.images[2].alt}
                      class="w-full h-full object-cover transition-all duration-700 group-hover:scale-110"
                      width="600"
                      height="450"
                      loading={index < 2 ? "eager" : "lazy"}
                      fetchpriority={index === 0 ? "high" : undefined}
                    />
                  ) : (
                    <div class="w-full h-full"></div>
                  )}
                  <div class="absolute inset-0 bg-black/30 group-hover:bg-black/45 transition-all duration-500"></div>
                </div>
              </div>

              {/* Card Content Overlay */}
              <div class="absolute inset-0 bg-linear-to-t from-black/70 via-black/45 to-black/15 group-hover:from-black/80 group-hover:via-black/55 group-hover:to-black/25 transition-all duration-500 p-6 flex flex-col justify-end">
                <h3 class="text-white text-2xl md:text-3xl font-bold mb-2 tracking-wide uppercase transform translate-y-0 group-hover:-translate-y-2 transition-transform duration-300 font-['Bebas_Neue']">
                  {category.name}
                </h3>
                <p class="text-slate-light text-xs md:text-sm leading-relaxed opacity-0 group-hover:opacity-100 transform translate-y-4 group-hover:translate-y-0 transition-all duration-500 font-light mb-3">
                  {category.description}
                </p>

                {/* View Gallery Indicator */}
                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                  <span class="text-bronze text-xs font-medium tracking-wider">VIEW GALLERY</span>
                  <svg class="w-3 h-3 text-bronze transition-transform group-hover:translate-x-1 duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>

    <!-- Featured Projects - Tight Horizontal Strip -->
    {featuredPhotos.length > 0 && (
      <section class="featured-section py-10 md:py-12 bg-charcoal border-t border-bronze/10 overflow-hidden group/section scroll-reveal opacity-0">
        <!-- Minimal header - left aligned -->
        <div class="pl-6 md:pl-8 mb-4 md:mb-6">
          <span class="text-bronze text-[10px] md:text-xs font-medium tracking-widest uppercase">Featured</span>
        </div>

        <!-- Flush-left horizontal strip -->
        <div class="relative">
          <!-- Right edge fade -->
          <div class="absolute right-0 top-0 bottom-0 w-20 md:w-32 bg-gradient-to-l from-charcoal to-transparent z-10 pointer-events-none"></div>

          <!-- Navigation arrows - visible on hover -->
          <button
            id="featured-prev"
            class="absolute left-2 top-1/2 -translate-y-1/2 z-20 w-10 h-10 bg-black/60 hover:bg-bronze text-white flex items-center justify-center opacity-0 group-hover/section:opacity-100 transition-all duration-300 disabled:opacity-0"
            aria-label="Scroll left"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <button
            id="featured-next"
            class="absolute right-2 top-1/2 -translate-y-1/2 z-20 w-10 h-10 bg-black/60 hover:bg-bronze text-white flex items-center justify-center opacity-0 group-hover/section:opacity-100 transition-all duration-300"
            aria-label="Scroll right"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>

          <!-- Scrollable container - flush left, drag enabled -->
          <div id="featured-strip" class="overflow-x-auto overflow-y-hidden scrollbar-hide cursor-grab active:cursor-grabbing">
            <div class="flex gap-1">
              {featuredPhotos.map((photo: any, index: number) => (
                <a
                  href={`/gallery/${photo.category}`}
                  class="featured-item shrink-0 group relative overflow-hidden select-none"
                  draggable="false"
                >
                  <div class="w-64 md:w-72 lg:w-80 aspect-4/3 overflow-hidden">
                    <img
                      src={urlFor(photo.image).width(640).height(480).auto('format').url()}
                      alt={photo.alt || photo.title}
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 pointer-events-none"
                      width="640"
                      height="480"
                      loading={index < 4 ? "eager" : "lazy"}
                      draggable="false"
                    />
                  </div>
                  <!-- Gradient overlay -->
                  <div class="absolute inset-0 bg-linear-to-t from-black/70 via-transparent to-transparent group-hover:from-black/80 transition-all duration-300"></div>
                  <!-- Title -->
                  <div class="absolute bottom-0 left-0 right-0 p-4">
                    <h3 class="font-['Bebas_Neue'] text-base md:text-lg text-white tracking-wide">
                      {photo.title}
                    </h3>
                  </div>
                </a>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Bronze gradient line - Marks end of main content -->
    <div class="bronze-gradient-divider"></div>

    <!-- Social Proof Strip - Luxury Minimal -->
    <section class="social-proof-section bg-black-pure py-16 md:py-24 border-t border-bronze/10 relative overflow-hidden">
      <!-- Subtle radial glow -->
      <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,rgba(184,134,11,0.06)_0%,transparent_70%)] pointer-events-none"></div>

      <div class="container max-w-5xl mx-auto px-6 md:px-8 relative z-10">
        <div class="flex flex-col items-center gap-10 md:gap-12">

          <!-- Heading with gradient divider -->
          <div class="text-center space-y-4 scroll-reveal opacity-0" style="animation-delay: 0.1s">
            <div class="w-16 h-0.5 bg-gradient-to-r from-transparent via-bronze to-transparent mx-auto"></div>
            <h2 class="font-['Bebas_Neue'] text-3xl md:text-4xl text-white tracking-[0.15em]">
              EXPLORE MORE OF OUR WORK
            </h2>
            <p class="text-slate-light text-sm tracking-wider font-light">
              Follow our latest projects on social media
            </p>
          </div>

          <!-- Social Icons -->
          <div class="flex gap-8 scroll-reveal opacity-0" style="animation-delay: 0.2s">
            <a
              href="https://www.tiktok.com/@rockyconcreteinc"
              target="_blank"
              rel="noopener noreferrer"
              class="group w-16 h-16 flex items-center justify-center border-2 border-bronze/40 text-bronze hover:border-bronze hover:bg-bronze/10 transition-all duration-300 hover:scale-110 hover:shadow-[0_0_32px_rgba(184,134,11,0.4)]"
              aria-label="TikTok"
            >
              <Icon name="logo-tiktok" class="text-3xl" />
            </a>
            <a
              href="https://www.instagram.com/rockyconcreteinc/"
              target="_blank"
              rel="noopener noreferrer"
              class="group w-16 h-16 flex items-center justify-center border-2 border-bronze/40 text-bronze hover:border-bronze hover:bg-bronze/10 transition-all duration-300 hover:scale-110 hover:shadow-[0_0_32px_rgba(184,134,11,0.4)]"
              aria-label="Instagram"
            >
              <Icon name="logo-instagram" class="text-3xl" />
            </a>
            <a
              href="https://m.facebook.com/RockyConcreteInc/"
              target="_blank"
              rel="noopener noreferrer"
              class="group w-16 h-16 flex items-center justify-center border-2 border-bronze/40 text-bronze hover:border-bronze hover:bg-bronze/10 transition-all duration-300 hover:scale-110 hover:shadow-[0_0_32px_rgba(184,134,11,0.4)]"
              aria-label="Facebook"
            >
              <Icon name="logo-facebook" class="text-3xl" />
            </a>
          </div>

        </div>
      </div>
    </section>

    <!-- CTA Section - Luxury Industrial -->
    <section class="cta-section bg-black-pure section-padding border-t border-bronze/10">
      <div class="container max-w-4xl mx-auto px-6 md:px-8 text-center scroll-reveal opacity-0">
        <h2
          class="font-['Bebas_Neue'] text-4xl md:text-5xl tracking-wider text-white mb-6"
        >
          Ready to Start Your Project?
        </h2>
        <div class="bronze-divider mx-auto mb-8"></div>
        <p
          class="text-lg md:text-xl text-slate-light font-light leading-relaxed mb-10 max-w-2xl mx-auto"
        >
          Let us transform your outdoor space with quality craftsmanship and
          exceptional service.
        </p>
        <a
          href="/#cta"
          class="btn-primary"
        >
          Get Your Free Estimate
        </a>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  import {
    initScrollAnimations,
    CONTENT_CONFIG,
    CARD_CONFIG,
    CTA_CONFIG,
    STRIP_CONFIG
  } from '../utils/animations.js';

  // Hero page-load animation - staggered like Hero.astro
  // Uses 900ms timing for luxury feel (defined in animations.css)
  document.addEventListener("DOMContentLoaded", () => {
    const heroElements = document.querySelectorAll(".hero-animate");
    heroElements.forEach((el) => {
      el.classList.add("animate-fade-in-up");
    });
  });

  // Section intro text - standard content reveal
  initScrollAnimations('.section-intro.scroll-reveal', CONTENT_CONFIG);

  // Category cards - higher threshold so user sees animation happen
  // Uses quick 400ms animation for snappy grid feel
  initScrollAnimations('.category-card.scroll-reveal', CARD_CONFIG);

  // Featured section - animate whole section (horizontal scrollers don't work well with individual item observers)
  initScrollAnimations('.featured-section.scroll-reveal', STRIP_CONFIG);

  // Social proof section - gentle/slower animation for emphasis
  initScrollAnimations('.social-proof-section .scroll-reveal', CTA_CONFIG);

  // CTA section - gentle/slower animation, triggers early
  initScrollAnimations('.cta-section .scroll-reveal', CTA_CONFIG);

  // Featured strip - drag to scroll + arrow navigation
  const strip = document.getElementById('featured-strip');
  const prevBtn = document.getElementById('featured-prev');
  const nextBtn = document.getElementById('featured-next');

  if (strip) {
    // Drag to scroll
    let isDown = false;
    let startX: number;
    let scrollLeft: number;
    let hasDragged = false;

    strip.addEventListener('mousedown', (e) => {
      isDown = true;
      hasDragged = false;
      strip.style.cursor = 'grabbing';
      startX = e.pageX - strip.offsetLeft;
      scrollLeft = strip.scrollLeft;
    });

    strip.addEventListener('mouseleave', () => {
      isDown = false;
      strip.style.cursor = 'grab';
    });

    strip.addEventListener('mouseup', () => {
      isDown = false;
      strip.style.cursor = 'grab';
    });

    strip.addEventListener('mousemove', (e) => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - strip.offsetLeft;
      const walk = (x - startX) * 1.5;
      if (Math.abs(walk) > 5) hasDragged = true;
      strip.scrollLeft = scrollLeft - walk;
    });

    // Prevent click navigation if user was dragging
    strip.addEventListener('click', (e) => {
      if (hasDragged) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, true);

    // Arrow button navigation
    const scrollAmount = 320; // Roughly one card width

    prevBtn?.addEventListener('click', () => {
      strip.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    });

    nextBtn?.addEventListener('click', () => {
      strip.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    });

    // Update prev button visibility based on scroll position
    const updatePrevVisibility = () => {
      if (prevBtn) {
        prevBtn.style.display = strip.scrollLeft <= 10 ? 'none' : 'flex';
      }
    };
    strip.addEventListener('scroll', updatePrevVisibility);
    updatePrevVisibility();
  }
</script>

<style>
  /* Import reusable animations */
  @import '../styles/animations.css';

  /* Hero animation optimization */
  .hero-animate {
    will-change: transform, opacity;
  }

  /* Hide scrollbar but keep functionality */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>
