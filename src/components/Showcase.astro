---
import { sanityClient, urlFor } from "../sanity/client";

// Fetch featured gallery items from Sanity
const featuredItems = await sanityClient.fetch(`
  *[_type == "galleryItem" && featured == true] | order(order asc) {
    _id,
    title,
    alt,
    image
  }
`);
---

<section class="section-showcase section-padding bg-white border-t border-bronze/10" id="showcase">
  <div class="container max-w-7xl mx-auto px-6 md:px-8">
    <!-- Heading with Bronze Divider -->
    <div class="text-center mb-12 md:mb-16 showcase-reveal opacity-0" style="animation-delay: 0.1s">
      <h2 class="section-heading text-black-pure mb-4">
        See What We've Built
      </h2>
      <div class="bronze-divider mx-auto"></div>
    </div>
  </div>

  <!-- Slider Wrapper -->
  <div class="slider-wrapper relative w-full max-w-6xl mx-auto px-6 md:px-8 showcase-reveal opacity-0" style="animation-delay: 0.2s">
    <!-- Slider Container -->
    <div class="slider relative w-full h-[500px] md:h-[600px] lg:h-[650px] overflow-hidden shadow-2xl">
      {featuredItems.length > 0 ? (
        featuredItems.map((item: any, index: number) => (
          <img
            src={urlFor(item.image).url()}
            alt={item.alt || item.title}
            class="slide absolute w-full transition-transform duration-1000"
            loading={index === 0 ? "eager" : "lazy"}
          />
        ))
      ) : (
        <div class="w-full h-full bg-charcoal flex items-center justify-center">
          <span class="text-slate text-lg">No featured photos yet - mark some as featured in Sanity!</span>
        </div>
      )}

      <!-- Left Arrow Button -->
      <button
        class="slider__btn slider__btn--left absolute top-1/2 left-[3%] md:left-[6%] -translate-x-1/2 -translate-y-1/2 bg-white/90 border-2 border-black-pure/20 h-12 w-12 sm:h-14 sm:w-14 md:h-16 md:w-16 rounded-sm flex items-center justify-center shadow-lg cursor-pointer text-lg md:text-xl text-black-pure transition-all duration-300 hover:bg-white hover:border-bronze hover:text-bronze focus-visible:outline-none z-100"
        aria-label="Previous slide"
      >
        &larr;
      </button>

      <!-- Right Arrow Button -->
      <button
        class="slider__btn slider__btn--right absolute top-1/2 right-[3%] md:right-[6%] translate-x-1/2 -translate-y-1/2 bg-white/90 border-2 border-black-pure/20 h-12 w-12 sm:h-14 sm:w-14 md:h-16 md:w-16 rounded-sm flex items-center justify-center shadow-lg cursor-pointer text-lg md:text-xl text-black-pure transition-all duration-300 hover:bg-white hover:border-bronze hover:text-bronze focus-visible:outline-none z-100"
        aria-label="Next slide"
      >
        &rarr;
      </button>

      <!-- Dots Container (will be populated by JavaScript) -->
      <div class="dots absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-3 z-100"></div>
    </div>
  </div>

  <!-- View Full Showcase Link -->
  <div class="container max-w-7xl mx-auto px-6 md:px-8">
    <div class="text-center mt-16 md:mt-20 showcase-reveal opacity-0" style="animation-delay: 0.3s">
      <a
        href="/gallery"
        class="inline-block font-['Inter'] text-base md:text-lg text-black-pure no-underline border-b-2 border-black-pure pb-1 transition-all duration-300 hover:text-bronze hover:border-bronze tracking-wide"
      >
        View Full Gallery &rarr;
      </a>
    </div>
  </div>
</section>

<style is:global>
  /* Slide styles - cropped effect like original */
  .slide {
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 1;
  }

  /* Dot styles - must be global for dynamically created elements */
  .dots__dot {
    width: 10px !important;
    height: 10px !important;
    background: rgba(255, 255, 255, 0.6) !important;
    border: 2px solid rgba(255, 255, 255, 0.8) !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    padding: 0 !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
  }

  .dots__dot:hover {
    background: rgba(255, 255, 255, 0.9) !important;
    border-color: var(--color-bronze) !important;
    transform: scale(1.2);
  }

  .dots__dot--active {
    background: var(--color-bronze) !important;
    border-color: var(--color-bronze) !important;
    transform: scale(1.3);
    box-shadow: 0 2px 10px rgba(184, 134, 11, 0.4) !important;
  }

  /* Showcase Reveal Animations */
  @keyframes showcaseFadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .showcase-reveal.animate-in {
    animation: showcaseFadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .showcase-reveal {
    will-change: transform, opacity;
  }
</style>

<script is:inline>
  // Slider functionality
  const slider = function () {
    const slides = document.querySelectorAll(".slide");
    const btnLeft = document.querySelector(".slider__btn--left");
    const btnRight = document.querySelector(".slider__btn--right");
    const dotContainer = document.querySelector(".dots");

    if (!slides.length || !btnLeft || !btnRight || !dotContainer) return;

    let curSlide = 0;
    const maxSlide = slides.length;

    // Functions
    const createDots = function () {
      slides.forEach(function (_, i) {
        dotContainer.insertAdjacentHTML(
          "beforeend",
          `<button class="dots__dot" data-slide="${i}" aria-label="Go to slide ${i + 1}"></button>`
        );
      });
    };

    const activateDot = function (slide) {
      document
        .querySelectorAll(".dots__dot")
        .forEach((dot) => dot.classList.remove("dots__dot--active"));

      const activeDot = document.querySelector(`.dots__dot[data-slide="${slide}"]`);
      if (activeDot) {
        activeDot.classList.add("dots__dot--active");
      }
    };

    const goToSlide = function (slide) {
      slides.forEach(
        (s, i) => (s.style.transform = `translateX(${100 * (i - slide)}%)`)
      );
    };

    // Next slide
    const nextSlide = function () {
      if (curSlide === maxSlide - 1) {
        curSlide = 0;
      } else {
        curSlide++;
      }

      goToSlide(curSlide);
      activateDot(curSlide);
    };

    const prevSlide = function () {
      if (curSlide === 0) {
        curSlide = maxSlide - 1;
      } else {
        curSlide--;
      }
      goToSlide(curSlide);
      activateDot(curSlide);
    };

    const init = function () {
      goToSlide(0);
      createDots();
      activateDot(0);
    };
    init();

    // Event handlers
    btnRight.addEventListener("click", nextSlide);
    btnLeft.addEventListener("click", prevSlide);

    document.addEventListener("keydown", function (e) {
      if (e.key === "ArrowLeft") prevSlide();
      e.key === "ArrowRight" && nextSlide();
    });

    dotContainer.addEventListener("click", function (e) {
      if (e.target.classList.contains("dots__dot")) {
        const { slide } = e.target.dataset;
        goToSlide(slide);
        activateDot(slide);
      }
    });
  };
  slider();

  // Showcase scroll animations
  (function() {
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-in');
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);

    document.querySelectorAll('.section-showcase .showcase-reveal').forEach((el) => {
      observer.observe(el);
    });
  })();
</script>
